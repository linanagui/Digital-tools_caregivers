---
title: "NHATS_caregiver_HRRP_datasets"
output:
  pdf_document: default
  html_document: default
  word_document: default
date: "2025-02-27"
---

1st: NHATS datasets (caregivers/digital tools)

# Focusing on Digital tools first:

1.NHATS_Round_13_Tab_Act_Frequencies.sas7bdat → Covers assistive devices, telehealth, vision, hearing, mobility
2.NHATS_Round_13_Accel_Track_Frequencies.sas7bdat → Covers activity tracking & wearables
3.NHATS_Round_13_Accel_Summ_Frequencies.sas7bdat → Summarizes activity tracking & movement data
4.NHATS_Round_13_Accel_Det_Frequencies.sas7bdat → Tracks accelerometer wear days & device use

```{r}
# Load necessary libraries
library(haven)    # For reading SAS files
library(dplyr)    # For data manipulation
library(readr)    # For exporting CSV

# Set file paths (Update these based on your file locations)
tracker_data <- read_sas("~/desktop/NHATS_R13_Final_Release_SAS/Tracker_files/NHATS_Round_13_Tracker_File.sas7bdat")
tab_act <- read_sas("~/desktop/NHATS_R13_Final_Release_SAS/Tab_act_files/NHATS_Round_13_Tab_Act_File.sas7bdat")
accel_track <- read_sas("~/desktop/NHATS_R13_Final_Release_SAS/Accel_track_files/NHATS_Round_13_Accel_Track_File.sas7bdat")
accel_summ <- read_sas("~/desktop/NHATS_R13_Final_Release_SAS/Accel_summ_files/NHATS_Round_13_Accel_Summ_File.sas7bdat")
accel_det <- read_sas("~/desktop/NHATS_R13_Final_Release_SAS/Accel_det_files/NHATS_Round_13_Accel_Det_File.sas7bdat")

# Save as CSV
# write.csv(tracker_data, "tracker_data.csv", row.names = FALSE)
# write.csv(tab_act, "tab_act.csv", row.names = FALSE)
# write.csv(accel_track, "accel_track.csv", row.names = FALSE)
# write.csv(accel_summ, "accel_summ.csv", row.names = FALSE)
# write.csv(accel_det, "accel_det.csv", row.names = FALSE)

# Select relevant columns based on codebooks
tab_act_selected <- tab_act %>%
  select(spid, vh13vision, vh13hearing) %>%
  rename(
    participant_id = spid,
    uses_vision_aid = vh13vision,   # Vision aid use (glasses, magnifiers)
    uses_hearing_aid = vh13hearing  # Hearing aid use
  )

accel_track_selected <- accel_track %>%
  select(spid, ag13accelerometry, ag13dstatus) %>%
  rename(
    participant_id = spid,
    uses_activity_tracker = ag13accelerometry,  # Whether the participant wore an activity tracker
    tracker_completion_status = ag13dstatus    # Status of device use
  )

accel_summ_selected <- accel_summ %>%
  select(spid, ag13dnumdays, ag13dtac, ag13dsatp)%>%
  rename(
    participant_id = spid,
    activity_tracker_days_worn = ag13dnumdays,  # Number of days the tracker was worn
    total_activity_counts = ag13dtac,           # Movement data collected by tracker
    sedentary_to_active_transitions = ag13dsatp # How often participant moved from sitting to active state
  )

accel_det_selected <- accel_det %>%
  select(spid, ag13dday, ag13dvalid)%>%
  rename(
    participant_id = spid,
    days_worn_tracker = ag13dday,   # Number of days the tracker was recorded
    tracker_data_validity = ag13dvalid # Whether the data from tracker was valid
  )

# Merge datasets using left joins on 'participant_id'
merged_digital_tools_data <- tab_act_selected %>%
  left_join(accel_track_selected, by = "participant_id") %>%
  left_join(accel_summ_selected, by = "participant_id") %>%
  left_join(accel_det_selected, by = "participant_id")

# View summary of merged dataset
glimpse(merged_digital_tools_data)

# Save the final merged dataset as a CSV file
write_csv(merged_digital_tools_data, "NHATS_Merged_Digital_Tools.csv")
```


Next, working on the remaining datasets that focus more on caregivers, patients, and merge them with the cleaned digital tools dataset:

```{r}
# Install necessary packages (run once)
#install.packages(c("haven", "tidyverse", "janitor", "skimr"))

#install.packages("tinytex")
#tinytex::install_tinytex()  # Install full LaTeX distribution

# Load libraries
library(haven)      # To read .sas7bdat files
library(tidyverse)  # For data wrangling
library(janitor)    # For cleaning column names
library(skimr)      # For summarizing datasets

# Load NHATS data files
nhats_sp <- read_sas("~/desktop/NHATS_R13_Final_Release_SAS/SP_files/NHATS_Round_13_SP_File.sas7bdat") # Sample Person Data
nhats_op <- read_sas("~/desktop/NHATS_R13_Final_Release_SAS/OP_files/NHATS_Round_13_OP_File.sas7bdat") # Caregiver Data
merged_digital_tools <- read_csv("~/desktop/NHATS_Merged_Digital_tools.csv") # Digital tool use data
inc_path <- read_sas("~/desktop/NHATS_R13_Final_Release_SAS/Inc_files/NHATS_R13_Int_Inc_Imp_File.sas7bdat")

# Clean column names
nhats_sp <- nhats_sp %>% clean_names()
nhats_op <- nhats_op %>% clean_names()
merged_digital_tools <- merged_digital_tools %>% clean_names()
nhats_inc <- inc_path %>% clean_names()  # Income & Socioeconomic Data

# Check variables
colnames(nhats_sp)
colnames(nhats_op)
colnames(merged_digital_tools)
colnames(nhats_inc)
```


Select Key NHATS Variables for Readmission & Caregiving Analysis

Extract caregiver involvement, digital tool use, and chronic disease status.

```{r}
# Select and rename relevant variables from NHATS_SP (Older Adults Data)
nhats_sp_filtered <- nhats_sp %>%
  select(
    spid,              # Unique respondent ID
    r13dresid,         # Residential status (community, assisted living, nursing home)
    r13dgender,        # Gender of respondent
    r13d2intvrage,     # Age of respondent
    hc13disescn1, hc13disescn2, hc13disescn3, hc13disescn4, hc13disescn5, 
    hc13disescn6, hc13disescn7, hc13disescn8, hc13disescn9, hc13disescn10,  # Chronic diseases
    is13proxlivsp,     # Does caregiver live with respondent?
    is13prxyrelat,     # Relationship of the proxy caregiver
    is13prxygendr,     # Gender of the proxy caregiver
    em13paydevce1:em13paydevce6  # Assistive technology usage
  )%>%
  rename(
    participant_id = spid,
    residence_type = r13dresid,         # Residential status (community, assisted living, nursing home)
    respondent_gender = r13dgender,     # Gender of respondent
    respondent_age = r13d2intvrage,     # Age of respondent
    has_heart_disease = hc13disescn1,   
    has_hypertension = hc13disescn2,
    has_lung_disease = hc13disescn3,
    has_diabetes = hc13disescn4,
    has_cancer = hc13disescn5,
    has_stroke = hc13disescn6,
    has_arthritis = hc13disescn7,
    has_dementia = hc13disescn8,
    has_depression = hc13disescn9,
    has_other_chronic = hc13disescn10,
    caregiver_lives_with_respondent = is13proxlivsp, # Does the caregiver live with respondent?
    caregiver_relationship = is13prxyrelat, # Relationship of the proxy caregiver
    caregiver_gender = is13prxygendr, # Gender of the proxy caregiver
    uses_assistive_tech_1 = em13paydevce1, # Assistive technology device 1
    uses_assistive_tech_2 = em13paydevce2, # Assistive technology device 2
    uses_assistive_tech_3 = em13paydevce3, # Assistive technology device 3
    uses_assistive_tech_4 = em13paydevce4, # Assistive technology device 4
    uses_assistive_tech_5 = em13paydevce5, # Assistive technology device 5
    uses_assistive_tech_6 = em13paydevce6  # Assistive technology device 6
  )
```


```{r}
# Select and rename relevant variables from NHATS_OP (Caregivers Data)
nhats_op_filtered <- nhats_op %>%
  select(
    spid,             # Unique respondent ID (for merging)
    op13relatnshp,    # Relationship of caregiver to respondent
    op13proxy,        # Whether caregiver answered on behalf of respondent
    op13dage,         # Age of the caregiver
    op13numhrsday,    # Hours of caregiving per day
    op13numdayswk     # Days of caregiving per week
  ) %>%
  rename(
    participant_id = spid,
    caregiver_relationship_to_respondent = op13relatnshp, # Relationship of caregiver to respondent
    caregiver_answered_for_respondent = op13proxy, # Whether caregiver answered on behalf of respondent
    caregiver_age = op13dage, # Age of the caregiver
    caregiver_hours_per_day = op13numhrsday, # Hours of caregiving per day
    caregiver_days_per_week = op13numdayswk # Days of caregiving per week
  )
```


```{r}
# Select and rename relevant variables from NHATS_Inc (Income & Socioeconomic Data)
nhats_inc_filtered <- nhats_inc %>%
  select(
    spid,              # Unique respondent ID (for merging)
    ia13toincimif      # Imputed total income
  ) %>%
  rename(
    participant_id = spid,
    total_income = ia13toincimif # Imputed total income
  )
```

```{r}
# View summary of cleaned datasets
glimpse(nhats_sp_filtered)
glimpse(nhats_op_filtered)
glimpse(nhats_inc_filtered)
```



-----------------------------

Merge Caregiver & Digital Tool Use Data

Merge NHATS caregiving data with digital tool usage

```{r}
# Merge NHATS_SP with NHATS_OP (Caregiver + Care Recipient Data)
nhats_merged <- nhats_sp_filtered %>%
  left_join(nhats_op_filtered, by = "participant_id") %>%
  left_join(merged_digital_tools, by = "participant_id") %>%
  left_join(nhats_inc_filtered, by = "participant_id")

# Check merged dataset
glimpse(nhats_merged)
```

Handle Missing Values
NHATS datasets use special codes (-9, -1) for missing values, which we replace with NA.
```{r}
# Replace missing values (-9 and -1) with NA
nhats_cleaned <- nhats_merged %>%
  mutate(across(everything(), ~ na_if(.x, -9))) %>%
  mutate(across(everything(), ~ na_if(.x, -1)))

# Check missing values summary
colSums(is.na(nhats_cleaned))
```



Now, we have caregiver data linked to NHATS participants’ chronic conditions and digital tool use.


Save the Cleaned & Merged Dataset
```{r}
# Save as CSV
write_csv(nhats_cleaned, "NHATS_Cleaned_Caregivers_and_DigitalTools.csv")

# Save as RData for easy reloading
# save(nhats_cleaned, file = "NHATS_Cleaned_Caregivers_DigitalTools.RData")
```


---------------------------------------




2nd DATASET "HRRP":

```{r}
#install.packages(c("tidyverse", "janitor", "readr"))
library(tidyverse)
library(janitor)

# Load HRRP dataset (adjust file path if needed)
hrrp_data <- read_csv("~/desktop/FY_2025_Hospital_Readmissions.csv")
```

```{r}
# Clean column names
hrrp_data <- hrrp_data %>% clean_names()

# View first few rows
head(hrrp_data)

# Check unique readmission measures
unique(hrrp_data$measure_name)
```

# Filter HRRP Data for Relevant Conditions
Since we are focusing on heart failure, COPD, and heart attack, we extract only those rows:
```{r}
hrrp_filtered <- hrrp_data %>%
  filter(measure_name %in% c(
    "READM-30-HF-HRRP",   # Heart Failure
    "READM-30-AMI-HRRP",  # Acute Myocardial Infarction (Heart Attack)
    "READM-30-COPD-HRRP", # Chronic Obstructive Pulmonary Disease
    "READM-30-PN-HRRP",   # Pneumonia
    "READM-30-CABG-HRRP", # Coronary Artery Bypass Graft Surgery
    "READM-30-THA-TKA-HRRP" # Total Hip/Knee Arthroplasty
  )) %>%
  select(facility_name, state, measure_name, excess_readmission_ratio, predicted_readmission_rate, expected_readmission_rate, number_of_readmissions)

# View summary
summary(hrrp_filtered)

# Save the final merged dataset as a CSV file
# write_csv(hrrp_filtered, "HRRP_cleaned_data.csv")
```










--------------------------------------------


3rd: Merging NHATS and HRRP (direct merge is not possible, so it can be done using condition level aggregation):

Merge by Chronic Condition & State
	•	This allows us to analyze how digital tool adoption by caregivers (NHATS) relates to hospital readmission rates (HRRP) for specific conditions.
	•	This approach will enable state-level insights about digital health tools in caregiving and their relationship with hospital readmissions.

```{r}
# Load necessary libraries
library(dplyr)
library(readr)

# Standardize column names for merging
nhats_cleaned_data <- nhats_cleaned %>%
  rename(state = State, chronic_condition = Condition)  # Adjust if needed

hrrp_filtered_data <- hrrp_filtered %>%
  rename(state = state, chronic_condition = measure_name)  # Adjust if needed

# Merge datasets by state and condition
merged_datasets <- nhats_cleaned_data %>%
  inner_join(hrrp_filtered_data, by = c("state", "chronic_condition"))

# View summary of merged dataset
summary(merged_datasets)

# Save the merged dataset
write_csv(merged_datasets, "Merged_NHATS_HRRP_Data.csv")

# Display first few rows
head(merged_datasets)
```


